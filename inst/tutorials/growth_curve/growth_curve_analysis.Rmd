---
title: "E. coli Growth Rate Analysis"
author: "Avery J. C. Noonan<br>
        Enabled by notes from Stephan Koenig and Linnea, as well as the contribution of several Educe TAs. <br>
        A tutorial by [ECOSCOPE](http://ecoscope.ubc.ca/) at UBC."
date: "version `r format(Sys.time(), '%B %d, %Y')`"
description: In-depth description will follow.
output:
  learnr::tutorial:
      progressive: true
      allow_skip: true
runtime: shiny_prerendered
---

- Make questions

```{r setup, include=FALSE}
# General learnr setup
library(learnr)
library(gradethis)
library(knitr)
library(berryFunctions)
gradethis_setup()
knitr::opts_chunk$set(echo = TRUE, message=FALSE, warning=FALSE)
library(educer)
# Helper function to set path to images to "/images" etc.
setup_resources()

# Tutorial specific setup
library(tidyverse)
library("growthrates")
```

## Introduction
*E. coli* cultures were innoculated in a 96-well plate in both rich media (LB) and minimal media (MM).  Optical density (OD~600~) measurements were taken over approximately 24 hours, as a metric of cell number, using a microplate reader.

In this tutorial, we will import optical density (OD~600~) data and plot growth curves of the *E. coli* cultures. We will then use the `growthrates` package to calculate maximum growth rates, before determining whether there s a statistical difference between the growth rates of culture in LB and MM.

## Environment Setup and Data Import
Necessary packages are first loaded into R, using the `library(<package>)` function. In this tutorial, we use the following packages:

* `tidyverse`
* `"growthrates"`

Custom function with the suffix `EDU` (`<function>_EDU()`) were designed for this tutorial and are combine functions from the package above. For educational purposes details can be found in the "Helper Function" section of this tutorial.

Files `growth_data.csv` and `well_information.csv` are imported using the `tidyverse` function `read_csv()`.

```{r import, message=TRUE}
library(tidyverse)
library("growthrates")

raw_growth_data <- read_csv(system.file("resources/data",  "growth_data.csv", package = "educer"), col_names = TRUE, skip = 12)
well_data <- read_csv(system.file("resources/data", "well_information.csv", package = "educer"), col_names = TRUE)
```

## Data Processing
When analyzing data, it is often important to reformat and combine data sets for analysis or visualizations using specific packages or functions.  We will use function from the `tidyverse` package to reformat, combine and filter OD~600~ and well information data accordingly.

The key steps in this process are:

1. `raw_growth_data` reformatting
    + Functions: `pivot_longer()`

2. Joining `growth_data` and `well_data`
    + Functions: `right_join()` and `filter()`

3. Calculating OD~600~ in "blank" wells at T~0~ to generate `blank_**` values for different media types
    + Functions: `calc_blank_EDU(<dataframe>, <Media-Type>)`

4. Calculating `net_OD` values (blank OD~600~ values subtracted from measured OD~600~) for each media type separately
    + Functions: `filter()` and `mutate() `
    
5. Binding separated dataframes to make a single dataframe with `net_OD` values for all wells and timepoints
    + Functions: `bind_rows()`

```{r data_reformating_setup}
library(tidyverse)
library("growthrates")

raw_growth_data <- read_csv(system.file("resources/data",  "growth_data.csv", package = "educer"), col_names = TRUE, skip = 12)
well_data <- read_csv(system.file("resources/data", "well_information.csv", package = "educer"), col_names = TRUE)

calc_blank_EDU <- function(dataframe, Media) {
  blank_OD <- dataframe %>%
  filter(!is.na(Time)) %>%
  filter(blank == TRUE, media == Media ) %>%
  summarise(blank_OD = min(OD600))

  output <- blank_OD[[1]]
  
  return(output)
}

growth_data <- raw_growth_data %>%
  pivot_longer(-c(Time, Temp), names_to = 'well', values_to = 'OD600')

growth_data_info <- right_join(growth_data, well_data, by = 'well') %>%
  filter(!is.na(student), !is.na(Time))
```

The code below shows how the functions described above can be use to reformat `raw_growth_data` into the dataframe that will be used for future analysis.

```{r data_reformating1, exercise=TRUE, exercise.setup = "data_reformating_setup"}
growth_data <- raw_growth_data %>%
  pivot_longer(-c(Time, Temp), names_to = 'well', values_to = 'OD600')

growth_data_info <- right_join(growth_data, well_data, by = 'well') %>%
  filter(!is.na(student), !is.na(Time))

blank_LB <- calc_blank_EDU(growth_data_info, 'LB')

blank_MM <- calc_blank_EDU(growth_data_info, 'MM')

growth_data_LB <- growth_data_info %>%
  filter(media == 'LB') %>%
  mutate(net_OD = OD600 - blank_LB)

growth_data_MM <- growth_data_info %>%
  filter(media == 'MM') %>%
  mutate(net_OD = OD600 - blank_MM)

growth_data_full <- bind_rows(growth_data_LB, growth_data_MM)
```

Use the interactive box below to calculate (as shown above) and display the values of `blank_LB` and `blank_MM` variables.

```{r data_reformating2, exercise=TRUE, exercise.setup = "data_reformating_setup"}
blank_LB <-
print(blank_LB)
  
blank_MM <- 
print(blank_MM)
```

What is the value of `blank_LB`?

```{r blank_LB_check, exercise=TRUE, exercise.setup = "data_reformating_setup"}

```

```{r blank_LB_check-check}
grade_result(
  pass_if(~identical(.result, 0.085))
)
```

What is the value of `blank_MM`?

```{r blank_MM_check, exercise=TRUE, exercise.setup = "data_reformating_setup"}

```

```{r blank_MM_check-check}
grade_result(
  pass_if(~identical(.result, 0.075))
)
```

```{r letter-a, echo=FALSE}
question("Does the relationship between `blank_LB` and `blank_MM` values make sense?",
  answer("No, we would expect values to be identical"),
  answer("Yes, LB medium is darker coloured that Minimal medium, so we expect the OD~600~ of LB to be slightly higher", correct = TRUE),
  answer("No, Minimal medium is darker coloured that LB medium, so we expect the OD~600~ of MM to be slightly higher"),
  answer("We have no way of knowing what these values might be"),
  random_answer_order = TRUE,
  allow_retry = TRUE
)
```

## Plotting Growth Curves
_E. coli_ growth curves represent the optical density of cultures over time. The shape of these curves has been extensively characterized by the scientific community and plotting these curves can help identify irregularities or contamination.

We are generating these plots using the `ggplot2` package, which is part of the `tidyverse` library.

```{r plotting_growth_curves_setup}
raw_growth_data <- read_csv(system.file("resources/data",  "growth_data.csv", package = "educer"), col_names = TRUE, skip = 12)
well_data <- read_csv(system.file("resources/data", "well_information.csv", package = "educer"), col_names = TRUE)

calc_blank_EDU <- function(dataframe, Media) {
  blank_OD <- dataframe %>%
  filter(!is.na(Time)) %>%
  filter(blank == TRUE, media == Media ) %>%
  summarise(blank_OD = min(OD600))

  output <- blank_OD[[1]]
  
  return(output)
}

growth_data <- raw_growth_data %>%
  pivot_longer(-c(Time, Temp), names_to = 'well', values_to = 'OD600')

growth_data_info <- right_join(growth_data, well_data, by = 'well') %>%
  filter(!is.na(student), !is.na(Time))

blank_LB <- calc_blank_EDU(growth_data_info, 'LB')

blank_MM <- calc_blank_EDU(growth_data_info, 'MM')

growth_data_LB <- growth_data_info %>%
  filter(media == 'LB') %>%
  mutate(net_OD = OD600 - blank_LB)

growth_data_MM <- growth_data_info %>%
  filter(media == 'MM') %>%
  mutate(net_OD = OD600 - blank_MM)

growth_data_full <- bind_rows(growth_data_LB, growth_data_MM)

growthrate_model_EDU <- function(filtered_dataframe) {
  growth_fit <-fit_easylinear(filtered_dataframe$Time, filtered_dataframe$net_OD)
  
  output <- growth_fit@par[[3]]
  return(output)
}

growthrate_plot_EDU <- function(filtered_dataframe) {
  growth_fit <- fit_easylinear(filtered_dataframe$Time, filtered_dataframe$net_OD)
  return(plot(growth_fit))
}

calc_growthrates_EDU <- function(dataframe) {
  growth_rates <- dataframe %>%
    distinct(interaction(well), .keep_all = TRUE) %>%
    select(c(well, student, blank, media)) %>%
    filter(blank == FALSE)
  
  growth_rates$growth_rate <- NA
  for (w in 1:length(growth_rates$well)){
    growth_rate_data <- dataframe %>%
    filter(well == growth_rates$well[w])
    
    error_check <- is.error(fit_easylinear(growth_rate_data$Time, growth_rate_data$net_OD))
    if (error_check == FALSE) {
      growth_fit <- fit_easylinear(growth_rate_data$Time, growth_rate_data$net_OD)
      growth_rates$growth_rate[w] = growth_fit@par[[3]]
    }
  }
  output <- growth_rates
  return(output)
}
```

The code below generates a graph showing all measured OD~600~ values over time.  Using the `filter()` function, modify the code below to show only non-blank samples.

```{r plotting_growth_curves1, exercise=TRUE, exercise.setup = "plotting_growth_curves_setup"}
growth_data_full %>%
  # filter(blank == FALSE) %>%
  ggplot(aes(x=Time, y=net_OD)) +
  geom_point() + 
  labs(x = 'Time (h:m:s)', y = 'OD600')
```

```{r plotting_growth_curves1-solution}
growth_data_full %>%
  filter(blank == FALSE) %>%
  ggplot(aes(x=Time, y=net_OD)) +
  geom_point() + 
  labs(x = 'Time (h:m:s)', y = 'OD600')
```

Now copy the code above into the box below and define the `colour` aesthetic as `media`, in order to differentiate between LB and MM.

```{r plotting_growth_curves2, exercise=TRUE, exercise.setup = "plotting_growth_curves_setup"}

```

```{r plotting_growth_curves2-solution}
growth_data_full %>%
  filter(blank == FALSE) %>%
  ggplot(aes(x=Time, y=net_OD, colour = media)) +
  geom_point() + 
  labs(x = 'Time (h:m:s)', y = 'OD600')
```

Try modifying the code to show only blank samples and use the `colour` aesthetic as `media`, in order to differentiate between LB and MM.

```{r plotting_growth_curves3, exercise=TRUE, exercise.setup = "plotting_growth_curves_setup"}

```

```{r plotting_growth_curves3-solution}
growth_data_full %>%
  filter(blank == TRUE) %>%
  ggplot(aes(x=Time, y=net_OD, colour = media)) +
  geom_point() + 
  labs(x = 'Time (h:m:s)', y = 'OD600')
```

```{r growth_data_question, echo=FALSE}
question("Are there any irregularities in the graphs above? (select ALL that apply)",
  answer("Only two blank LB wells grew, we would expect to see more"),
  answer("The first measurement seems to have given erroneous values", correct = TRUE),
  answer("We don't expect to see any growth in the blank wells, but a number seem to have been contaminated", correct = TRUE),
  answer("LB and MM growth curves should look the same, as both are E. coli"),
  answer("The data looks as expected"))
```

Use the `filter()` and `min()` functions to remove the first timepoint from the dataset.  Define a new dataframe called `growth_data_trim` and plot the growth curves of non-blank cultures.

```{r plotting_growth_curves4, exercise=TRUE, exercise.setup = "plotting_growth_curves_setup"}
growth_data_trim <- growth_data_full %>%
  
growth_data_trim %>%
  ggplot(aes(x = , y =)) +
```

```{r plotting_growth_curves4-hint-1}
Time !=   # Time is not equal to
```

```{r plotting_growth_curves4-hint-2}
Time != min(Time)  # Time is not equal to the minimum (first) timepoint 
```

```{r plotting_growth_curves4-hint-3}
filter(blank == FALSE)
```

```{r plotting_growth_curves4-solution}
growth_data_trim <- growth_data_full %>%
  filter(Time != min(Time))

growth_data_trim %>%
  filter(blank == FALSE) %>%
  ggplot(aes(x=Time, y=net_OD, colour = media)) +
  geom_point() + 
  labs(x = 'Time (h:m:s)', y = 'OD600')
```

## Calculating Growth Rates

Here, we use the `growthrate_model_EDU(<fitlered_dataframe>)` and `growthrate_plot_EDU(<fitlered_dataframe>)` functions to model and plot the maximum growth rate of a single sample.  To do this, first filter your dataframe down to a single `well`.

```{r calculating_rates_setup}
raw_growth_data <- read_csv(system.file("resources/data",  "growth_data.csv", package = "educer"), col_names = TRUE, skip = 12)
well_data <- read_csv(system.file("resources/data", "well_information.csv", package = "educer"), col_names = TRUE)

calc_blank_EDU <- function(dataframe, Media) {
  blank_OD <- dataframe %>%
  filter(!is.na(Time)) %>%
  filter(blank == TRUE, media == Media ) %>%
  summarise(blank_OD = min(OD600))

  output <- blank_OD[[1]]
  
  return(output)
}

growth_data <- raw_growth_data %>%
  pivot_longer(-c(Time, Temp), names_to = 'well', values_to = 'OD600')

growth_data_info <- right_join(growth_data, well_data, by = 'well') %>%
  filter(!is.na(student), !is.na(Time))

blank_LB <- calc_blank_EDU(growth_data_info, 'LB')

blank_MM <- calc_blank_EDU(growth_data_info, 'MM')

growth_data_LB <- growth_data_info %>%
  filter(media == 'LB') %>%
  mutate(net_OD = OD600 - blank_LB)

growth_data_MM <- growth_data_info %>%
  filter(media == 'MM') %>%
  mutate(net_OD = OD600 - blank_MM)

growth_data_full <- bind_rows(growth_data_LB, growth_data_MM)

growthrate_model_EDU <- function(filtered_dataframe) {
  growth_fit <-fit_easylinear(filtered_dataframe$Time, filtered_dataframe$net_OD)
  
  output <- growth_fit@par[[3]]
  return(output)
}

growthrate_plot_EDU <- function(filtered_dataframe) {
  growth_fit <- fit_easylinear(filtered_dataframe$Time, filtered_dataframe$net_OD)
  return(plot(growth_fit))
}

calc_growthrates_EDU <- function(dataframe) {
  growth_rates <- dataframe %>%
    distinct(interaction(well), .keep_all = TRUE) %>%
    select(c(well, student, blank, media)) %>%
    filter(blank == FALSE)
  
  growth_rates$growth_rate <- NA
  for (w in 1:length(growth_rates$well)){
    growth_rate_data <- dataframe %>%
    filter(well == growth_rates$well[w])
    
    error_check <- is.error(fit_easylinear(growth_rate_data$Time, growth_rate_data$net_OD))
    if (error_check == FALSE) {
      growth_fit <- fit_easylinear(growth_rate_data$Time, growth_rate_data$net_OD)
      growth_rates$growth_rate[w] = growth_fit@par[[3]]
    }
  }
  output <- growth_rates
  return(output)
}

growth_data_trim <- growth_data_full %>%
  filter(Time != min(Time))
```

```{r test_growth_rates, exercise=TRUE, exercise.setup = "calculating_rates_setup"}
single_well_data <- growth_data_trim %>%
  filter(well == 'A10')

growthrate_model_EDU(single_well_data)

growthrate_plot_EDU(single_well_data)
```

Use the `growthrate_model_EDU()` and `growthrate_plot_EDU()` functions to calculate and plot maximum growth rates for the following cultures:
```{r table1, echo = FALSE, results = 'asis'}
raw_growth_data <- read_csv(system.file("resources/data",  "growth_data.csv", package = "educer"), col_names = TRUE, skip = 12)
well_data <- read_csv(system.file("resources/data", "well_information.csv", package = "educer"), col_names = TRUE)

calc_blank_EDU <- function(dataframe, Media) {
  blank_OD <- dataframe %>%
  filter(!is.na(Time)) %>%
  filter(blank == TRUE, media == Media ) %>%
  summarise(blank_OD = min(OD600))

  output <- blank_OD[[1]]
  
  return(output)
}

growth_data <- raw_growth_data %>%
  pivot_longer(-c(Time, Temp), names_to = 'well', values_to = 'OD600')

growth_data_info <- right_join(growth_data, well_data, by = 'well') %>%
  filter(!is.na(student), !is.na(Time))

blank_LB <- calc_blank_EDU(growth_data_info, 'LB')

blank_MM <- calc_blank_EDU(growth_data_info, 'MM')

growth_data_LB <- growth_data_info %>%
  filter(media == 'LB') %>%
  mutate(net_OD = OD600 - blank_LB)

growth_data_MM <- growth_data_info %>%
  filter(media == 'MM') %>%
  mutate(net_OD = OD600 - blank_MM)

growth_data_full <- bind_rows(growth_data_LB, growth_data_MM)

growthrate_model_EDU <- function(filtered_dataframe) {
  growth_fit <-fit_easylinear(filtered_dataframe$Time, filtered_dataframe$net_OD)
  
  output <- growth_fit@par[[3]]
  return(output)
}

growthrate_plot_EDU <- function(filtered_dataframe) {
  growth_fit <- fit_easylinear(filtered_dataframe$Time, filtered_dataframe$net_OD)
  return(plot(growth_fit))
}

calc_growthrates_EDU <- function(dataframe) {
  growth_rates <- dataframe %>%
    distinct(interaction(well), .keep_all = TRUE) %>%
    select(c(well, student, blank, media)) %>%
    filter(blank == FALSE)
  
  growth_rates$growth_rate <- NA
  for (w in 1:length(growth_rates$well)){
    growth_rate_data <- dataframe %>%
    filter(well == growth_rates$well[w])
    
    error_check <- is.error(fit_easylinear(growth_rate_data$Time, growth_rate_data$net_OD))
    if (error_check == FALSE) {
      growth_fit <- fit_easylinear(growth_rate_data$Time, growth_rate_data$net_OD)
      growth_rates$growth_rate[w] = growth_fit@par[[3]]
    }
  }
  output <- growth_rates
  return(output)
}

table <- growth_data_full %>%
  filter(well %in% c('A2', 'A4', 'A8', 'A10')) %>%
  filter(Time == min(Time)) %>%
  select(c(well, student, blank, media))

kable(table, caption = '_Table 1:_ Wells for `growthrate` calculations')
```

Using what you've learned, plot the growth curves for all of the wells identified in _Table 1_

```{r test_growth_rates1, exercise=TRUE, exercise.setup = "calculating_rates_setup"}

```

```{r test_growth_rates1-hint-1}
well == '***' # plot one well at a time filter for all 4 using the OR operator ' | '
```

```{r test_growth_rates1-hint-2}
filter(well == 'A2' | well == 'A4'...)
```

```{r test_growth_rates1-solution}
growth_data_trim %>%
  filter(well == 'A2' | well == 'A4' | well == 'A8' | well == 'A10') %>%
  ggplot(aes(x=Time, y=net_OD, colour = media)) +
  geom_point() + 
  labs(x = 'Time (h:m:s)', y = 'OD600')
```

Using the functions described above, calculate and plot growthrates for all non-blank wells identified in _Table 1_ (the `growthrate_model_EDU()` is not dsigned to handle growth rates of near 0)

```{r test_growth_rates2, exercise=TRUE, exercise.setup = "calculating_rates_setup"}

```

```{r test_growth_rates2-hint-1}
single_well_data <- growth_data_trim %>% # dataframe must be filtered to 1 well
  filter(well == 'A4')
```

```{r test_growth_rates2-solution}
single_well_data <- growth_data_trim %>%
  filter(well == 'A4')

growthrate_model_EDU(single_well_data)

growthrate_plot_EDU(single_well_data)
```

What is the growth rate of well A4?

```{r C4_check, exercise=TRUE, exercise.setup = "calculating_rates_setup"}

```

```{r C4_check-check}
grade_result(
  pass_if(~identical(.result, 0.0001247002))
)
```

What is the growth rate of well A10?

```{r C10_check, exercise=TRUE, exercise.setup = "calculating_rates_setup"}

```

```{r C10_check-check}
grade_result(
  pass_if(~identical(.result, 9.921588e-05))
)
```

```{r growth_rates_question, echo=FALSE}
question("Is the relationship between _E. coli_ growth rates in LB and MM as expected?",
  answer("The max growth rate in LB is  more than 1.25 times the max growth rate in MM. We would expect it to be slightly higher.", correct = TRUE),
  answer("The max growth rate in LB is more than 10 times the max growth rate in MM. We would expect it to be higher."),
  answer("The max growth rate in LB is about 1.25 times the max growth rate in MM. This seem incorect, as we would expect it to be slightly lower."),
  answer("We don't have a way of predicting the relationship between growth rates in LB vs. MM"),
  answer("The max growth rate in MM is more than 1.25 times the max growth rate in LB This seem incorect, as we would expect it to be slightly lower."),
  random_answer_order = TRUE,
  allow_retry = TRUE
  )
```

Use the `calc_growthrate(<dataframe>)` function to calculate growth rates for all the wells in a your dataframe, outputting a new dataframe.  

```{r calculating_growth_rates, exercise=TRUE, exercise.setup = "calculating_rates_setup"}
growth_rates <-

growth_rates
```

```{r calculating_growth_rates-solution}
growth_rates <- calc_growthrates_EDU(growth_data_trim)

growth_rates
```

## Data Distribution
Understanding the distribution of data and the relationship between data sets is important in determining what kind of statistical analyses should be performed.

In the following section, we plot the distribution of the calculated growth rates using the `geom_density` function from `ggplot2`

```{r plotting_growth_rates_setup}
raw_growth_data <- read_csv(system.file("resources/data",  "growth_data.csv", package = "educer"), col_names = TRUE, skip = 12)
well_data <- read_csv(system.file("resources/data", "well_information.csv", package = "educer"), col_names = TRUE)

calc_blank_EDU <- function(dataframe, Media) {
  blank_OD <- dataframe %>%
  filter(!is.na(Time)) %>%
  filter(blank == TRUE, media == Media ) %>%
  summarise(blank_OD = min(OD600))

  output <- blank_OD[[1]]
  
  return(output)
}

growth_data <- raw_growth_data %>%
  pivot_longer(-c(Time, Temp), names_to = 'well', values_to = 'OD600') %>%
  filter(Time != min(Time))

growth_data_info <- right_join(growth_data, well_data, by = 'well') %>%
  filter(!is.na(student), !is.na(Time))

blank_LB <- calc_blank_EDU(growth_data_info, 'LB')

blank_MM <- calc_blank_EDU(growth_data_info, 'MM')

growth_data_LB <- growth_data_info %>%
  filter(media == 'LB') %>%
  mutate(net_OD = OD600 - blank_LB)

growth_data_MM <- growth_data_info %>%
  filter(media == 'MM') %>%
  mutate(net_OD = OD600 - blank_MM)

growth_data_full <- bind_rows(growth_data_LB, growth_data_MM)

calc_growthrates_EDU <- function(dataframe) {
  growth_rates <- dataframe %>%
    distinct(interaction(well), .keep_all = TRUE) %>%
    select(c(well, student, blank, media)) %>%
    filter(blank == FALSE)
  
  growth_rates$growth_rate <- NA
  for (w in 1:length(growth_rates$well)){
    growth_rate_data <- dataframe %>%
    filter(well == growth_rates$well[w])
    
    error_check <- is.error(fit_easylinear(growth_rate_data$Time, growth_rate_data$net_OD))
    if (error_check == FALSE) {
      growth_fit <- fit_easylinear(growth_rate_data$Time, growth_rate_data$net_OD)
      growth_rates$growth_rate[w] = growth_fit@par[[3]]
    }
  }
  output <- growth_rates
  return(output)
}

growth_data_trim <- growth_data_full %>%
  filter(Time != min(Time))

growth_rates <- calc_growthrates_EDU(growth_data_trim)
```

```{r data_distribution, exercise=TRUE, exercise.setup = "plotting_growth_rates_setup"}
growth_rates %>%
  ggplot(aes(x=growth_rate, color = media)) +
  geom_density()
```

## Statistical Analysis
In order to determine whether there is a significant difference between growth rates in LB and MM media, we will employ the `wilcox_test()` function, from the `rstatix` package. Growth rate distributions are also plotted using the `geom_boxplot()` function, from the `ggplot2` package.

```{r staistical_analysis, exercise=TRUE, exercise.setup = "plotting_growth_rates_setup"}
growth_rates %>%
  ggplot(aes(x=media, y = growth_rate, fill  = media)) +
  geom_boxplot()

growth_rate_ttest <- t.test(growth_rate ~ media, data = growth_rates, paired = FALSE)
growth_rate_ttest
```
