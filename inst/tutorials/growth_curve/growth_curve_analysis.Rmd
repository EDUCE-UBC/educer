---
title: "E. coli Growth Rate Analysis"
author: "Avery J. C. Noonan<br>
        Enabled by notes from Stephan Koenig and Linnea, as well as the contribution of several Educe TAs. <br>
        A tutorial by [ECOSCOPE](http://ecoscope.ubc.ca/) at UBC."
date: "version `r format(Sys.time(), '%B %d, %Y')`"
description: In-depth description will follow.
output:
  learnr::tutorial:
      progressive: true
      allow_skip: true
runtime: shiny_prerendered
---

```{r setup, include=FALSE}
# General learnr setup
library(learnr)
knitr::opts_chunk$set(echo = TRUE, message=FALSE, warning=FALSE)
library(educer)
# Helper function to set path to images to "/images" etc.
setup_resources()

# Tutorial specific setup
library(tidyverse)
library("growthrates")
library(rstatix)
```

## Introduction
*E. coli* cultures were innoculated in a 96-well plate in both rich media (LB) and minimal media (MM).  Optical density (OD~600~) measurements were taken over approximately 24 hours, as a metric of cell number, using a microplate reader.

In this tutorial, we will import optical density (OD~600~) data and plot growth curves of the *E. coli* cultures. We will then use the `growthrates` package to calculate maximum growth rates, before determining whether there s a statistical difference between the growth rates of culture in LB and MM.

## Environment Setup and Data Import
Necessary packages are first loaded into R, using the `library(<package>)` function. In this tutorial, we use the following packages:

* `tidyverse`
* `"growthrates"`
* `rstatix`

Custom function with the suffix `EDU` (`<function>_EDU()`) were designed for this tutorial and are combine functions from the package above. For educational purposes details can be found in the "Helper Function" section of this tutorial.

Files `growth_data.csv` and `well_information.csv` are imported using the `tidyverse` function `read_csv()`.

```{r import, message=TRUE}
library(tidyverse)
library("growthrates")
library(rstatix)

raw_growth_data <- read_csv(system.file("resources/data",  "growth_data.csv", package = "educer"), col_names = TRUE, skip = 12)
well_data <- read_csv(system.file("resources/data", "well_information.csv", package = "educer"), col_names = TRUE)
```

## Data Processing
When analyzing data, it is often important to reformat and combine data sets for analysis or visualizations using specific packages or functions.  We will use function from the `tidyverse` package to reformat, combine and filter OD~600~ and well information data accordingly.

The key steps in this process are:

1. `raw_growth_data` reformatting
    + Functions: `pivot_longer()`

2. Joining `growth_data` and `well_data`
    + Functions: `right_join()` and `filter()`

3. Calculating OD~600~ in "blank" wells at T~0~ to generate `blank_**` values for different media types
    + Functions: `calc_blank_EDU(<dataframe>, <Media-Type>)`

4. Calculating `net_OD` values (blank OD~600~ values subtracted from measured OD~600~) for each media type separately
    + Functions: `filter()` and `mutate() `
    
5. Binding separated dataframes to make a single dataframe with `net_OD` values for all wells and timepoints
    + Functions: `bind_rows()`

```{r data_reformating_setup}
library(tidyverse)
library("growthrates")
library(rstatix)

raw_growth_data <- read_csv(system.file("resources/data",  "growth_data.csv", package = "educer"), col_names = TRUE, skip = 12)
well_data <- read_csv(system.file("resources/data", "well_information.csv", package = "educer"), col_names = TRUE)

calc_blank_EDU <- function(dataframe, Media) {
  blank_OD <- dataframe %>%
  filter(!is.na(Time)) %>%
  filter(blank == TRUE, Time == min(.$Time), media == Media ) %>%
  summarise(blank_OD = mean(OD600))

  output <- blank_OD[[1]]
  
  return(output)
}

```

```{r data_reformating, exercise=TRUE, exercise.setup = "data_reformating_setup"}
growth_data <- raw_growth_data %>%
  pivot_longer(-c(Time, Temp), names_to = 'well', values_to = 'OD600')

growth_data_info <- right_join(growth_data, well_data, by = 'well') %>%
  filter(!is.na(student), !is.na(Time))

blank_LB <- calc_blank_EDU(growth_data_info, 'LB')

blank_MM <- calc_blank_EDU(growth_data_info, 'MM')

growth_data_LB <- growth_data_info %>%
  filter(media == 'LB') %>%
  mutate(net_OD = OD600 - blank_LB)

growth_data_MM <- growth_data_info %>%
  filter(media == 'MM') %>%
  mutate(net_OD = OD600 - blank_MM)

growth_data_full <- bind_rows(growth_data_LB, growth_data_MM)
```

## Plotting Growth Curves
_E. coli_ growth curves represent the optical density of cultures over time. The shape of these curves has been extensively characterized by the scientific community and plotting these curves can help identify irregularities or contamination.

We are generating these plots using the `ggplot2` package, wihich is part of the `tidyverse` library.

```{r plotting_growth_curves_setup}
raw_growth_data <- read_csv(system.file("resources/data",  "growth_data.csv", package = "educer"), col_names = TRUE, skip = 12)
well_data <- read_csv(system.file("resources/data", "well_information.csv", package = "educer"), col_names = TRUE)

calc_blank_EDU <- function(dataframe, Media) {
  blank_OD <- dataframe %>%
  filter(!is.na(Time)) %>%
  filter(blank == TRUE, Time == min(.$Time), media == Media ) %>%
  summarise(blank_OD = mean(OD600))

  output <- blank_OD[[1]]
  
  return(output)
}

growth_data <- raw_growth_data %>%
  pivot_longer(-c(Time, Temp), names_to = 'well', values_to = 'OD600')

growth_data_info <- right_join(growth_data, well_data, by = 'well') %>%
  filter(!is.na(student), !is.na(Time))

blank_LB <- calc_blank_EDU(growth_data_info, 'LB')

blank_MM <- calc_blank_EDU(growth_data_info, 'MM')

growth_data_LB <- growth_data_info %>%
  filter(media == 'LB') %>%
  mutate(net_OD = OD600 - blank_LB)

growth_data_MM <- growth_data_info %>%
  filter(media == 'MM') %>%
  mutate(net_OD = OD600 - blank_MM)

growth_data_full <- bind_rows(growth_data_LB, growth_data_MM)

growthrate_model_EDU <- function(filtered_dataframe) {
  growth_fit <-fit_easylinear(filtered_dataframe$Time, filtered_dataframe$net_OD)
  
  output <- growth_fit@par[[3]]
  return(output)
}

growthrate_plot_EDU <- function(filtered_dataframe) {
  growth_fit <- fit_easylinear(filtered_dataframe$Time, filtered_dataframe$net_OD)
  return(plot(growth_fit))
}

calc_growthrates_EDU <- function(dataframe) {
  growth_rates <- dataframe %>%
    distinct(well, .keep_all = TRUE) %>%
    select(c(well, student, blank, media)) %>%
    filter(blank == FALSE)
  
  growth_rates$growth_rate <- NA
  for (w in 1:length(growth_rates$well)){
    growth_rate_data <- dataframe %>%
      filter(well == growth_rates$well[w])
    
    growth_fit <- fit_easylinear(growth_rate_data$Time, growth_rate_data$net_OD)
    growth_rates$growth_rate[w] = growth_fit@par[[3]]
  }
  output <- growth_rates
  return(output)
}
```

```{r plotting_growth_curves, exercise=TRUE, exercise.setup = "plotting_growth_curves_setup"}
growth_data_full %>%
  filter(!is.na(student), blank == FALSE) %>%
  ggplot(aes(x=Time, y=net_OD, color = media, group = media)) +
  geom_point(shape=19, size=1)

growth_data_full %>%
  filter(!is.na(student), blank == TRUE) %>%
  ggplot(aes(x=Time, y=net_OD, color = media, group = media)) +
  geom_point(shape=19, size=1)
```

## Calculating Growth Rates

Here, we use the `growthrate_model_EDU(<fitlered_dataframe>)` and `growthrate_plot_EDU(<fitlered_dataframe>)` function to model and plot the maximum growth rate of a single sample.  To do this, first filter your dataframe down to a single `well`.

```{r test_growth_rates, exercise=TRUE, exercise.setup = "plotting_growth_curves_setup"}
test_data <- growth_data_full %>%
  filter(well == 'A10')

growthrate_model_EDU(test_data)

growthrate_plot_EDU(test_data)
```

Use the `calc_growthrate(<dataframe>)` function to calculate growth rates for all the wells in a your dataframe, outputting a new dataframe.  

```{r calculating_growth_rates, exercise=TRUE, exercise.setup = "plotting_growth_curves_setup"}
growth_rates <- calc_growthrates_EDU(growth_data_full)

growth_rates
```

## Data Distribution
Understanding the distribution of data and the relationship between data sets is important in determining what kind of statistical analyses should be performed.

In the following section, we plot the distribution of the calculated growth rates using the `geom_density` function from `ggplot2`

```{r plotting_growth_rates_setup}
raw_growth_data <- read_csv(system.file("resources/data",  "growth_data.csv", package = "educer"), col_names = TRUE, skip = 12)
well_data <- read_csv(system.file("resources/data", "well_information.csv", package = "educer"), col_names = TRUE)

calc_blank_EDU <- function(dataframe, Media) {
  blank_OD <- dataframe %>%
  filter(!is.na(Time)) %>%
  filter(blank == TRUE, Time == min(.$Time), media == Media ) %>%
  summarise(blank_OD = mean(OD600))

  output <- blank_OD[[1]]
  
  return(output)
}

growth_data <- raw_growth_data %>%
  pivot_longer(-c(Time, Temp), names_to = 'well', values_to = 'OD600')

growth_data_info <- right_join(growth_data, well_data, by = 'well') %>%
  filter(!is.na(student), !is.na(Time))

blank_LB <- calc_blank_EDU(growth_data_info, 'LB')

blank_MM <- calc_blank_EDU(growth_data_info, 'MM')

growth_data_LB <- growth_data_info %>%
  filter(media == 'LB') %>%
  mutate(net_OD = OD600 - blank_LB)

growth_data_MM <- growth_data_info %>%
  filter(media == 'MM') %>%
  mutate(net_OD = OD600 - blank_MM)

growth_data_full <- bind_rows(growth_data_LB, growth_data_MM)

calc_growthrates_EDU <- function(dataframe) {
  growth_rates <- dataframe %>%
    distinct(well, .keep_all = TRUE) %>%
    select(c(well, student, blank, media)) %>%
    filter(blank == FALSE)
  
  growth_rates$growth_rate <- NA
  for (w in 1:length(growth_rates$well)){
    growth_rate_data <- dataframe %>%
      filter(well == growth_rates$well[w])
    
    growth_fit <- fit_easylinear(growth_rate_data$Time, growth_rate_data$net_OD)
    growth_rates$growth_rate[w] = growth_fit@par[[3]]
  }
  output <- growth_rates
  return(output)
}

growth_rates <- calc_growthrates_EDU(growth_data_full)
```

```{r data_distribution, exercise=TRUE, exercise.setup = "plotting_growth_rates_setup"}
growth_rates %>%
  ggplot(aes(x=growth_rate, color = media)) +
  geom_density()
```

## Statistical Analysis
In order to determine whether there is a significant difference between growth rates in LB and MM media, we will employ the `wilcox_test()` function, from the `rstatix` package. Growth rate distributions are also plotted using the `geom_boxplot()` function, from the `ggplot2` package.

```{r staistical_analysis, exercise=TRUE, exercise.setup = "plotting_growth_rates_setup"}
growth_rates %>%
  ggplot(aes(x=media, y = growth_rate, fill  = media)) +
  geom_boxplot()

growth_rate_wilcox <- growth_rates %>%
  wilcox_test(growth_rate ~ media, paired = FALSE) %>%
  add_significance
growth_rate_wilcox
```
